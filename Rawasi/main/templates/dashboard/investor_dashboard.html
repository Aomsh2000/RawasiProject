{% extends 'main/base.html'%}
{%load static%}
{%block title%}<title>لوحة التحكم - المستثمر</title>{%endblock%}
{%block head%}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
body {
  background-image: url("/static/images/Background.png");
  background-size: cover;
}
</style>
{%endblock%}
{%block content%}
<section class="container rounded-3 dashboard shadow">
  <div class="row dashboard-row">
      <!-- Sidebar -->
      <div class="col-md-3 p-3 d-flex flex-column justify-content-between dashboard-side">
        <div>
          <h4 class=" mb-4 text-center ">مرحبا <span>{{investor.user.full_name}}</span></h4>
          <ul class="nav flex-column dashboard-links">
              <li class="nav-item">
               
                
                <a class="nav-link-dashboard active" href="#" data-content="section1">
                  <i class="fa-solid fa-boxes-stacked"></i>
                  <span class="px-2">الصناديق</span> 
                </a>

              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section2">
                    <i class="fa-solid fa-bullhorn"></i>
                    <span class="px-2">التصويت</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section3">
                    <i class="fa-solid fa-coins"></i>
                    <span class="px-2">الأرباح</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section4">
                    <i class="fa-solid fa-wallet"></i>
                    <span class="px-2">المحفظة</span> 
                  </a>
              </li>
              <li class="nav-item">
                  <a class="nav-link-dashboard" href="#" data-content="section5">
                    <i class="fa-regular fa-address-card"></i>
                    <span class="px-2">حسابي</span> 
                  </a>
              </li>
          </ul>
        </div>
        <div class="d-flex justify-content-center">
      <button class="btn btn-darkgreen" data-bs-toggle="modal" data-bs-target="#codeModal">
        انضمام   </button>
          <!-- Modal Structure -->
          <div class="modal fade" id="codeModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              
              <div class="modal-content">
                <div class="modal-header border-white d-flex justify-content-between">
                    <h5 class="modal-title" id="exampleModalLabel">الرمز</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{%url 'main:investor_dashboard_view'%}">
                        {% csrf_token %}
                        <input type="text" name="join_code" maxlength="10" class="form-control" placeholder="أدخل رمز الانضمام" required/>
                        <div class="modal-footer border-white">
                            <button type="submit" class="btn btn-darkgreen">ارسال</button>
                        </div>
                    </form>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
    <!-- Content Area -->
    <div class="col-md-9 p-3">
        {% if messages %}
        {% for message in messages %}
        {% if not request.session.show_message or message.tags != request.session.show_message %}
        <div class=" w-100">
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} w-100 d-flex justify-content-between align-items-center" role="alert">
                {{ message }}
            <button type="button" class="btn-close m-0 px-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
            </div>
            {% endif %}
        {% endfor %}
      {% endif %}
        <div id="section1" class="dashboard-section">
            <div class="container mt-5">
                <!-- Investor Dashboard Header -->
                <h3>صناديق الاستثمار التي انضممت إليها</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>اسم الصندوق</th>
                            <th>المبلغ المستثمر</th>
                            <th>الأرباح</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fund in profit_data %}
                            <tr>
                                <td>{{ fund.fund_name }}</td>
                                <td>{{ fund.amount_invested }} ريال</td>
                                <td>{{ fund.profit }} ريال</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4">لا توجد صناديق استثمار للعرض.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>            
        </div>        
          <div id="section2" class="dashboard-section" style="display: none;">
            <div class="row">
                <div  class="col-md-3 investment-card border p-0 rounded-3" >
                  <img src="{%static 'images/building-66375_1280.jpg'%}" class="w-100"/>
                  <div class="p-2">
                    <h5>اسم الاستثمار</h5>
                    <small>وصف الاستثمار</small>
                    <div class="d-flex justify-content-between">
                      <div class="d-flex gap-1">
                        <a href="" class="  p-0 text-success fs-5"> <i class="fa-solid fa-square-check"></i></a>
                        <a href="" class=" text-danger p-0 fs-5 "> <i class="fa-solid fa-square-xmark"></i></a>
                      </div>  
                      <a class="btn btn-darkgreen p-0 px-1 mx-1"><small> تفاصيل</small></a>
                    </div>
                    </div>
                </div>
              </div>
          </div>
          <div id="section3" class="dashboard-section" style="display: none;">
            <div class="container p-0">
                <!-- Section 3 Header -->
                <div class="text-center mb-4">
                    <h2 style="color: #761305;">تفاصيل الأرباح</h2>
                    <p>سحب الأرباح المحققة من استثماراتك</p>
                </div>
        
<!-- Profit Table -->
<div class="profit-container p-4 bg-white shadow-sm rounded">
    <table class="table table-striped text-center">
        <thead>
            <tr>
                <th>اسم الصندوق</th>
                <th>المبلغ المستثمر</th>
                <th>الأرباح المحققة</th>
                <th>الحالة</th>
                <th>إجراء</th>
            </tr>
        </thead>
        <tbody>
            {% for fund in profit_data %}
            <tr>
                <td>{{ fund.fund_name }}</td>
                <td>{{ fund.amount_invested }} ر.س</td>
                <td>{{ fund.profit }} ر.س</td>
                <td>{{ fund.status }}</td>  
                <td>
                    {% if fund.transfer_enabled %}
                    <button class="btn btn-action btn-darkred withdraw mb-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                        سحب الأرباح
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-disabled" disabled>غير متاح</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>                                                                                                    
    </table>
</div>
            </div>
        </div>        
        <div id="section4" class="dashboard-section" style="display: none;">
            <div class="container p-0">
                <!-- Section 4 Header -->
                <div class="wallet-header">
                    <h2>محفظتي الرقمية</h2>
                    <p>التحكم في أموالك بطريقة بسيطة وآمنة</p>
                </div>
                <!-- Wallet Container -->
<div class="wallet-container mt-4 p-3 bg-white shadow-sm rounded">
    {% if wallet %}
        <p><strong>الرصيد:</strong> {{ wallet.balance }} ريال</p>
        <p><strong>آخر تحديث:</strong> {{ wallet.last_updated|date:"Y-m-d H:i:s" }}</p>
    {% else %}
        <p>سيتم انشاء محفظتك خلال ثواني...</p>
    {% endif %}
</div>

                <button class="btn btn-action btn-darkgreen add-funds mb-2" data-bs-toggle="modal" data-bs-target="#depositModal">
                    إضافة أموال
                </button>
                <button class="btn btn-action btn-darkred transfer mb-2" data-bs-toggle="modal" data-bs-target="#transferModal">
                    تحويل الأموال
                </button>
                <div class="text-center mt-3">
                    <!-- Button to Trigger Modal -->
                    <button class="btn btn-action btn-darkred withdraw mb-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                        سحب الأرباح
                    </button>
                </div> 
                <a href="{% url 'investment_fund:wallet_view' %}" class="btn btn-darkgreen">عرض المحفظة</a>                       
            </div>
<!-- Deposit Modal -->
<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header d-flex justify-content-between">
              <h5 class="modal-title" id="depositModalLabel">إضافة أموال إلى المحفظة</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form method="POST" action="{% url 'investment_fund:deposit_to_wallet' %}">
                  {% csrf_token %}
                  <div class="mb-3">
                      <label for="amount" class="form-label">المبلغ</label>
                      <input type="number" name="amount" id="amount" class="form-control" placeholder="أدخل المبلغ" required>
                  </div>
                  <div class="mb-3">
                      <label for="description" class="form-label">الوصف</label>
                      <input type="text" name="description" id="description" class="form-control" placeholder="اختياري">
                  </div>
                  <button type="submit" class="btn btn-darkgreen w-100 mt-3">إتمام الإيداع</button>
              </form>
          </div>
      </div>
    </div>
  </div>
  

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between">
                <h5 class="modal-title" id="transferModalLabel">تحويل أموال إلى الصندوق</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Check if joined funds are available -->
                {% if joined_funds %}
                    <form method="POST" action="{% url 'investment_fund:transfer_to_fund' pk=joined_funds.first.fund.id %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="amount" class="form-label">المبلغ</label>
                            <input type="number" name="amount" class="form-control" id="amount" placeholder="أدخل المبلغ" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">الوصف (اختياري)</label>
                            <input type="text" name="description" id="description" class="form-control" placeholder="أدخل وصف التحويل">
                        </div>

                        <div class="mb-3">
                            <label for="fund_id" class="form-label">اختر صندوق الاستثمار</label>
                            <select name="fund_id" id="fund_id" class="form-control" required>
                                <option value="" disabled selected>اختر صندوق الاستثمار</option>
                                {% for fund in joined_funds %}
                                    <option value="{{ fund.fund.id }}">{{ fund.fund.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-darkred w-100">إتمام التحويل</button>
                    </form>
                {% else %}
                    <p class="text-center">لم تقم بالانضمام إلى أي صناديق استثمار بعد.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

                </div>
                  <div id="section5" class="dashboard-section" style="display: none;">
                    <div class="container-wrapper-profile">
                      <div id="alert-container"></div>
                      <div class="profile-container container">
                          <div class="profile-image-container row w-100">
                            <div class="col-md-8 d-flex gap-3 align-items-start ">
                              <h2 class="mb-3"> بيانات الحساب  </h2>
                              <div class="mt-2">
                                <span class="edit-icon" id="edit-image-icon"><i class="fas fa-pencil-alt"></i></span>
                                <span class="check-icon hidden" id="check-icon"><i class="fas fa-check"></i></span>    
                              </div>
                            </div>
                              <div class=" col-md-4">
                                <img src="{{ user.profile_picture.url }}" alt="Profile Image" class="profile-image rounded-3 " id="profile-img">
                              </div>
      
                          </div>
                          
                          <div class="profile-info mt-3">
                              <form id="profile-form" method="POST" enctype="multipart/form-data">
                                  {% csrf_token %}
                                  
                                  <div class="form-group">
                                      <label for="full_name">الاسم الكامل</label>
                                      <input type="text" class="form-control" value="{{ user.full_name }}" name="full_name" id="full-name" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="username">اسم المستخدم</label>
                                      <input type="text" class="form-control" value="{{ user.username }}" name="username" id="username" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="email">البريد الإلكتروني</label>
                                      <input type="email" class="form-control" value="{{ user.email }}" name="email" id="email" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="phone_number">رقم الجوال</label>
                                      <input type="text" class="form-control" value="{{ user.phone_number }}" name="phone_number" id="phone-number" disabled>
                                  </div>
                  
                                  <div class="form-group">
                                      <label for="dob">تاريخ الميلاد</label>
                                      <input type="date" class="form-control" value="{{ user.date_of_birth|date:'Y-m-d' }}" name="date_of_birth" id="dob" disabled>
                                  </div>
                  
                                  <div class="form-group hidden" id="profile-picture-group">
                                      <label for="profile_picture">الصورة الشخصية</label>
                                      <input type="file" class="form-control" name="profile_picture" id="profile-picture">
                                  </div>
                  
                                  <div class="form-group hidden" id="password-group">
                                      <label for="password">كلمة المرور الجديدة</label>
                                      <input type="password" class="form-control" placeholder="أدخل كلمة المرور الجديدة" name="password" id="password">
                                  </div>
                  
                                  <div class="form-group hidden" id="password-confirm-group">
                                      <label for="password_confirm">تأكيد كلمة المرور</label>
                                      <input type="password" class="form-control" placeholder="تأكيد كلمة المرور" name="password_confirm" id="password_confirm">
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>
               
                </div>

              </div>
              <!-- Withdraw Profit Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between">
                <h5 class="modal-title" id="withdrawProfitModalLabel">سحب الأرباح</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'investment_fund:withdraw_profit' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="amount" class="form-label">المبلغ المراد سحبه</label>
                        <input type="number" name="profit" id="amount" class="form-control" placeholder="أدخل المبلغ" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">الوصف (اختياري)</label>
                        <input type="text" name="description" id="description" class="form-control" placeholder="أدخل وصف السحب">
                    </div>
                    <div class="mb-3">
                        <label for="fund" class="form-label">اختار صندوق الاستثمار</label>
                        <select name="fund_id" class="form-control">
                            {% for fund in profit_data %}
                                <option value="{{ fund.fund_id }}">
                                    {{ fund.fund_name }} - ربح: {{ fund.profit }} ريال
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="action" class="form-label">العملية</label>
                        <select name="action" class="form-control">
                            <option value="withdraw_to_wallet">سحب إلى المحفظة</option>
                            <option value="reinvest_in_fund">إعادة استثمار في الصندوق</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-darkgreen w-100">تأكيد السحب</button>
                </form>                
            </div>
        </div>
    </div>
    
          <div id="section5" class="dashboard-section" style="display: none;">
                        <div class="container-wrapper-profile">
                          <div id="alert-container"></div>
                          <div class="profile-container container">
                              <div class="profile-image-container row w-100">
                                <div class="col-md-8 d-flex gap-3 align-items-start ">
                                  <h2 class="mb-3"> بيانات الحساب  </h2>
                                  <div class="mt-2">
                                    <span class="edit-icon" id="edit-image-icon"><i class="fas fa-pencil-alt"></i></span>
                                    <span class="check-icon hidden" id="check-icon"><i class="fas fa-check"></i></span>    
                                  </div>
                                </div>
                                  <div class=" col-md-4">
                                    <img src="{{ user.profile_picture.url }}" alt="Profile Image" class="profile-image rounded-3 " id="profile-img">
                                  </div>
    
                              </div>
                              
                              <div class="profile-info mt-3">
                                  <form id="profile-form" method="POST" enctype="multipart/form-data">
                                      {% csrf_token %}
                                      
                                      <div class="form-group">
                                          <label for="full_name">الاسم الكامل</label>
                                          <input type="text" class="form-control" value="{{ user.full_name }}" name="full_name" id="full-name" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="username">اسم المستخدم</label>
                                          <input type="text" class="form-control" value="{{ user.username }}" name="username" id="username" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="email">البريد الإلكتروني</label>
                                          <input type="email" class="form-control" value="{{ user.email }}" name="email" id="email" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="phone_number">رقم الجوال</label>
                                          <input type="text" class="form-control" value="{{ user.phone_number }}" name="phone_number" id="phone-number" disabled>
                                      </div>
                      
                                      <div class="form-group">
                                          <label for="dob">تاريخ الميلاد</label>
                                          <input type="date" class="form-control" value="{{ user.date_of_birth|date:'Y-m-d' }}" name="date_of_birth" id="dob" disabled>
                                      </div>
                      
                                      <div class="form-group hidden" id="profile-picture-group">
                                          <label for="profile_picture">الصورة الشخصية</label>
                                          <input type="file" class="form-control" name="profile_picture" id="profile-picture">
                                      </div>
                      
                                      <div class="form-group hidden" id="password-group">
                                          <label for="password">كلمة المرور الجديدة</label>
                                          <input type="password" class="form-control" placeholder="أدخل كلمة المرور الجديدة" name="password" id="password">
                                      </div>
                      
                                      <div class="form-group hidden" id="password-confirm-group">
                                          <label for="password_confirm">تأكيد كلمة المرور</label>
                                          <input type="password" class="form-control" placeholder="تأكيد كلمة المرور" name="password_confirm" id="password_confirm">
                                      </div>
                                  </form>
                              </div>
                          </div>
                      </div>
                  </div>   
      </div>
  

</section>
  {%endblock%}
  {%block script%}
  <script>
    $(document).ready(function () {
        $('#edit-image-icon').click(function () {
            $('input').prop('disabled', false);
            $('#profile-picture-group, #password-group, #password-confirm-group').removeClass('hidden');
            $('#save-btn-container').removeClass('hidden'); 
            $('#check-icon').removeClass('hidden'); 
            $('#edit-image-icon').hide(); 
        });
        $('#check-icon').click(function () {
            $('#profile-form').submit(); 
        });
        $('#profile-form').submit(function (e) {
            e.preventDefault();
            var formData = new FormData(this); 
            $.ajax({
                url: '{% url "accounts:update_profile" %}',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $('#full-name').val(response.full_name);
                    $('#username').val(response.username);
                    $('#email').val(response.email);
                    $('#phone-number').val(response.phone_number);
                    $('#dob').val(response.date_of_birth);
                    $('#profile-img').attr('src', response.profile_picture_url);
                    $('input').prop('disabled', true);
                    $('#profile-picture-group, #password-group, #password-confirm-group').addClass('hidden');
                    $('#save-btn-container').addClass('hidden');
                    $('#edit-image-icon').show();
                    $('#check-icon').addClass('hidden'); 
                    $('#alert-container').html('<div class="alert alert-success">تم تحديث البيانات بنجاح!</div>');
                    setTimeout(function() {
                        $('.alert').fadeOut();
                    }, 3000);
                },
                error: function(xhr, status, error) {
                    $('#alert-container').html('<div class="alert alert-danger">حدث خطأ أثناء التحديث.</div>');
                    setTimeout(function() {
                        $('.alert').fadeOut();
                    }, 3000);
                }
            });
        });
    });
  </script>

  <script>
    // Show relevant payment details based on selected method
    document.getElementById('payment-method').addEventListener('change', function() {
      const method = this.value;
      const paymentDetails = document.querySelectorAll('.payment-details');
      paymentDetails.forEach(detail => {
        detail.style.display = 'none';
      });
  
      if (method === 'bank') {
        document.getElementById('bank-details').style.display = 'block';
      } else if (method === 'credit-card') {
        document.getElementById('credit-card-details').style.display = 'block';
      } else if (method === 'e-wallet') {
        document.getElementById('e-wallet-details').style.display = 'block';
      }
    });
  </script>
  <script>
    // Handle the section content change
    const navLinks = document.querySelectorAll('.nav-link-dashboard');
    const sections = document.querySelectorAll('.dashboard-section');

    // Set the default visible section
    const defaultSection = 'section1'; // This can be any section you want to show by default
    document.getElementById(defaultSection).style.display = 'block';
    document.querySelector(`.nav-link-dashboard[data-content="${defaultSection}"]`).classList.add('active');
    
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            // Remove the 'active' class from all nav links
            navLinks.forEach(link => link.classList.remove('active'));
            // Add 'active' class to the clicked link
            link.classList.add('active');

            // Hide all sections
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the content corresponding to the clicked section
            const sectionId = link.getAttribute('data-content');
            const activeSection = document.getElementById(sectionId);
            activeSection.style.display = 'block';
        });
    });
</script>

{%endblock%}